# Azure Deployment Plan for Deepfake-Detect Project

## **Goal**
Deploy the Deepfake-Detect application to Azure Container Apps using Azure Developer CLI (azd) with Bicep for infrastructure as code. This plan covers deploying a FastAPI backend with ML capabilities, a Next.js frontend, and all supporting Azure resources.

## **Project Information**

**Deepfake-Detect** - Multi-service application for detecting crypto scam deepfakes

### Backend Service
- **Technology Stack**: Python 3.11 with FastAPI
- **Application Type**: ML-powered detection API with Perplexity AI integration
- **Features**: 
  - Image/video deepfake detection using PyTorch models
  - Text analysis for scam patterns
  - Real-time threat intelligence via Perplexity AI
  - URL scanning and wallet research
- **Containerization**: Dockerfile present in `backend/`
- **Port**: 8000
- **Dependencies**: 
  - External API: Perplexity AI (requires API key)
  - ML models: PyTorch-based deepfake detector
  - Video processing: yt-dlp, OpenCV

### Frontend Service
- **Technology Stack**: Next.js 14 with React 18
- **Application Type**: Web UI for flagging and reporting deepfakes
- **Containerization**: Dockerfile present in `frontend/`
- **Port**: 3000
- **Dependencies**: Backend API at backend service URL

### Hosting Recommendation
Azure Container Apps provides:
- Serverless container hosting with automatic scaling
- Built-in HTTPS and custom domains
- Microservices architecture support
- Cost-effective for variable workload patterns
- Integrated monitoring and logging

## **Azure Resources Architecture**

> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TB
    subgraph Internet
        Users[Users/Browser Extension]
    end
    
    subgraph Azure["Azure Resources"]
        subgraph ContainerEnv["Container Apps Environment"]
            Frontend[Frontend Container App<br/>Next.js]
            Backend[Backend Container App<br/>FastAPI + ML Models]
        end
        
        ACR[Azure Container Registry]
        AppInsights[Application Insights]
        LogAnalytics[Log Analytics Workspace]
        KeyVault[Azure Key Vault]
        
        Frontend -->|API Calls| Backend
        Backend -.->|Telemetry| AppInsights
        Frontend -.->|Telemetry| AppInsights
        AppInsights -->|Stores Logs| LogAnalytics
        Backend -->|Read Secrets| KeyVault
        Backend -.->|Pull Image| ACR
        Frontend -.->|Pull Image| ACR
    end
    
    subgraph External["External Services"]
        PerplexityAPI[Perplexity AI API]
    end
    
    Users -->|HTTPS| Frontend
    Backend -->|API Calls| PerplexityAPI
    
    style Frontend fill:#0078d4,color:#fff
    style Backend fill:#0078d4,color:#fff
    style ACR fill:#50e6ff
    style KeyVault fill:#ffb900
    style PerplexityAPI fill:#68217a,color:#fff
```

### Data Flow
- Users access the frontend Container App via HTTPS
- Frontend communicates with backend Container App for detection services
- Backend Container App pulls ML models and processes detection requests
- Backend integrates with Perplexity AI for enhanced threat intelligence
- Both container apps pull their images from Azure Container Registry
- All services send telemetry to Application Insights for monitoring
- Secrets (API keys) are stored in Azure Key Vault and accessed by backend

## **Recommended Azure Resources**

### Application Services

#### 1. Frontend Container App
- **Service Name**: `frontend`
- **Hosting Service Type**: Azure Container Apps
- **SKU**: Consumption (0.5 vCPU, 1 GB memory)
  - Auto-scales from 0 to 10 instances
  - Serverless billing model
  - Suitable for web UI with variable traffic
- **Configuration**:
  - Language: `nodejs`
  - dockerFilePath: `c:\dev\projects\Deepfake-Detect-1\frontend\Dockerfile`
  - dockerContext: `c:\dev\projects\Deepfake-Detect-1\frontend`
  - Target Port: `3000`
  - Environment Variables:
    - `BACKEND_API_URL` - Backend service URL (internal)
    - `NODE_ENV` - Production
  
#### 2. Backend Container App
- **Service Name**: `backend`
- **Hosting Service Type**: Azure Container Apps
- **SKU**: Consumption (1 vCPU, 2 GB memory)
  - Auto-scales from 1 to 10 instances
  - Higher resources for ML model inference
  - Supports PyTorch and ML workloads
- **Configuration**:
  - Language: `python`
  - dockerFilePath: `c:\dev\projects\Deepfake-Detect-1\backend\Dockerfile`
  - dockerContext: `c:\dev\projects\Deepfake-Detect-1\backend`
  - Target Port: `8000`
  - Environment Variables:
    - `PERPLEXITY_API_KEY` - Stored in Key Vault, referenced as secret
    - `PERPLEXITY_MODEL` - llama-3.1-sonar-small-128k-online
    - `PERPLEXITY_TIMEOUT` - 30
    - `DEEPFAKE_API_KEYS` - Stored in Key Vault, referenced as secret
    - `DEEPFAKE_RATE_LIMIT_PER_MIN` - 60
    - `APPLICATIONINSIGHTS_CONNECTION_STRING` - For telemetry
  - Dependencies:
    - Perplexity AI (External API)
    - Connection Type: API Key authentication
    - Required Environment Variables: `PERPLEXITY_API_KEY`

### Supporting Services

#### 1. Azure Container Registry
- **Service Type**: Azure Container Registry
- **SKU**: Basic
  - 10 GB storage
  - Suitable for development and small-scale production
  - Webhook support for CI/CD
- **Purpose**: Store Docker images for both frontend and backend

#### 2. Container Apps Environment
- **Service Type**: Azure Container Apps Environment
- **Configuration**: 
  - Shared environment for frontend and backend
  - Internal networking between apps
  - Log Analytics Workspace integration

#### 3. Application Insights
- **Service Type**: Azure Application Insights
- **SKU**: Pay-as-you-go
- **Purpose**: Application performance monitoring, telemetry, and diagnostics
- **Features**:
  - Request tracking
  - Exception logging
  - Performance metrics
  - Custom events for ML model predictions

#### 4. Log Analytics Workspace
- **Service Type**: Azure Log Analytics
- **SKU**: Pay-as-you-go (Per GB)
- **Purpose**: Centralized logging for all services
- **Configuration**: All Container Apps send logs here

#### 5. Azure Key Vault
- **Service Type**: Azure Key Vault
- **SKU**: Standard
- **Purpose**: Secure storage of secrets and API keys
- **Secrets to Store**:
  - `perplexity-api-key` - Perplexity AI API key
  - `deepfake-api-keys` - Application API keys for authentication
- **Configuration**:
  - Soft delete enabled
  - Purge protection enabled (best practice)
  - Access policies for managed identity

### Security Configurations

#### Managed Identity
- **Type**: User-assigned managed identity
- **Name**: `deepfake-detect-identity`
- **Purpose**: Secure access to Azure resources without storing credentials
- **Assignments**:
  - Both frontend and backend Container Apps use this identity
  - Identity has AcrPull role on Container Registry
  - Identity has Key Vault Secrets User role on Key Vault

#### Role Assignments
1. **AcrPull Role** (GUID: `7f951dda-4ed3-4680-a7ca-43fe172d538d`)
   - Assigned to: User-assigned managed identity
   - Scope: Azure Container Registry
   - Purpose: Pull container images during deployment

2. **Key Vault Secrets User Role** (GUID: `4633458b-17de-408a-b874-0445c86b69e6`)
   - Assigned to: User-assigned managed identity  
   - Scope: Azure Key Vault
   - Purpose: Read secrets (API keys) at runtime

#### Network Security
- HTTPS only for ingress
- Internal communication between frontend and backend
- CORS configured on backend for frontend domain

## **Execution Steps**

> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan.**

### 1. Provision Azure Infrastructure and Deploy the Application

#### 1.1 Get IaC Rules
- Use tool `deploy_iac_rules_get` with parameters:
  - deployment-tool: `AZD`
  - iac-type: `bicep`
  - resource-types: `containerapp,storage`

#### 1.2 Generate Bicep Files
Create infrastructure files under `infra/` directory:
- `main.bicep` - Main orchestration file
- `main.parameters.json` - Parameter values
- `core/` folder with reusable modules:
  - `containerApps.bicep` - Container Apps and Environment
  - `registry.bicep` - Container Registry
  - `monitoring.bicep` - Application Insights and Log Analytics
  - `security.bicep` - Key Vault and Managed Identity
  
#### 1.3 Pre-check Bicep Files
- Run `get_errors` tool on all Bicep files
- Fix any syntax or validation errors
- Ensure all required parameters are defined

#### 1.4 Create azd Configuration
- Create `azure.yaml` in project root
- Define services (frontend, backend)
- Configure docker build settings
- Set up environment variables and secrets

#### 1.5 Deploy with azd
```bash
# Login to Azure
azd auth login

# Initialize (if not done)
azd init

# Preview deployment
azd provision --preview

# Deploy infrastructure and applications
azd up
```

#### 1.6 Verify Deployment
- Check deployment output for resource URLs
- Verify all resources in Azure Portal
- Ensure containers are running

#### 1.7 Check Application Logs
- Use `deploy_app_logs_get` tool with azd environment name
- Verify both frontend and backend are healthy
- Check for any startup errors

### 2. Post-Deployment Configuration

#### 2.1 Add Secrets to Key Vault
```bash
# Add Perplexity API key
az keyvault secret set --vault-name <vault-name> --name perplexity-api-key --value <your-key>

# Add deepfake API keys
az keyvault secret set --vault-name <vault-name> --name deepfake-api-keys --value <your-keys>
```

#### 2.2 Restart Backend Container App
```bash
# Trigger restart to pick up secrets
azd deploy backend
```

#### 2.3 Test Endpoints
- Test frontend URL
- Test backend API endpoints
- Verify Perplexity integration

### 3. Summary

#### 3.1 Generate Summary
- Create `.azure/summary.copilotmd` with:
  - List of all deployment files created
  - Resource diagram (provisioned resources)
  - Application URLs
  - Next steps for configuration

## **Cost Optimization Tips**

- Container Apps scale to zero when idle (no cost during inactivity)
- Use Consumption plan for variable workloads
- Monitor Application Insights data ingestion (largest ongoing cost)
- Set retention policies on Log Analytics to control costs
- Use Basic tier for Container Registry (upgrade if needed)

## **Monitoring and Operations**

- Application Insights Dashboard: Monitor performance and errors
- Log Analytics Queries: Troubleshoot application issues
- Container App Metrics: Track scaling and resource usage
- Alerts: Set up alerts for failures or performance degradation

## **Next Steps After Deployment**

1. Configure custom domain and SSL certificate
2. Set up CI/CD pipeline with GitHub Actions
3. Configure scaling rules based on load patterns
4. Enable diagnostic settings for audit logging
5. Implement backup strategy for labeled data
6. Consider adding Azure Storage for ML model artifacts
7. Add Azure CDN for frontend static assets
